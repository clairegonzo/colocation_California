---
title: "Sensitivity Testing"
author: 'By: Claire Gonzales'
date: "2024-08-10"
output: 
  html_document: 
    theme: lumen
    toc: yes
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)

library(tidyverse)
library(here)
library(stats)
library(ggplot2)
library(stats)
```


## Read and wrangle in data
```{r}

output_main <- read.csv(here("data","bivalve_model","LookUpTable_201416.csv")) %>% 
  dplyr::select("site", "long", "lat", "yield")
output_s1 <- read.csv(here("data","bivalve_model","LookUpTable_s1.csv"))
output_s2 <- read.csv(here("data","bivalve_model","LookUpTable_s2.csv"))
output_s3 <- read.csv(here("data","bivalve_model","LookUpTable_s3.csv"))

```

```{r}
s1 <- output_s1 %>% 
  mutate(s1_yield = yield) %>% 
  dplyr::select("site", "long", "lat", "s1_yield")

s2 <- output_s2 %>% 
  mutate(s2_yield = yield) %>% 
  dplyr::select("site", "long", "lat", "s2_yield")

s3 <- output_s3 %>% 
  mutate(s3_yield = yield) %>% 
  dplyr::select("site", "long", "lat", "s3_yield")
```

Merging the 3 frames. Format will be wide so then we will make it longer.
```{r}
wide1 <- merge(output_main, s1, by = c("site", "long", "lat"), all = TRUE)

wide2 <- merge(s2, s3, by = c("site", "long", "lat"), all = TRUE)

wide <- merge(wide1, wide2, by = c("site", "long", "lat"), all = TRUE)
```

```{r}
alldata <- wide %>% 
  pivot_longer(yield:s3_yield,
               names_to = "test",
               values_to = "yield")
```

## Visualizations

```{r}
##boxplot and violin plot
ggplot(data = alldata, aes(x = test, y = yield, fill = test)) +
  geom_boxplot() +
  #geom_jitter(color="black", size=0.4, alpha=0.9) +
  theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
  theme_minimal()

ggplot(data = alldata, aes(x = test, y = yield, fill = test)) +
  geom_violin() +
  #geom_jitter(color="black", size=0.4, alpha=0.9) +
  theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
  theme_minimal()
```

## Percent change
```{r}
wide_percents <- wide %>% 
  mutate(s1_percchange = (((s1_yield-yield)/yield)*100),
         s2_percchange = (((s2_yield-yield)/yield)*100),
         s3_percchange = (((s3_yield-yield)/yield)*100),
         )

summary_percents <- wide_percents %>% 
  #group_by(site) %>% 
  summarize(mean_s1percchhange = mean(s1_percchange),
            mean_s2percchhange = mean(s2_percchange),
            mean_s3percchhange = mean(s3_percchange)
            )
```


## ANOVA
```{r}
summary(alldata)

```

```{r}
aov <- aov(yield ~ test, 
           data = alldata)

summary(aov)
```

```{r}
hist(aov$residuals)

ggplot(data = alldata, aes(sample = yield)) +
  geom_qq() +
  facet_wrap( ~ test) +
  theme_minimal()
```

## Visualization data transformations
This section deals with the production data and transformed production data from each of the 4 sub-models. We want to compare the transformed data to the theoretical transformation (line resulting from the equation we used to transform the data - how well do the data points sit on this line?).

I also want to use this opportunity to look at the production data (pre-transformation) in some non-spatial ways.

I will read in the rasters and then extract the value in each cell. 

Read in data using `terra`
```{r}
library(terra)
library(sf)
```

### Wave energy
```{r}
wave <- terra::rast(here("data", "tiff", "wave_linfunc_v1.tif"))
wave_raw <- terra::rast(here("data", "tiff", "wave_notransform.tif"))

terra::plot(wave, main = "Wave Energy (transformed linearly)")
terra::plot(wave_raw, main = "Wave Energy (no transformation)")
```

```{r}
wave_df <- terra::as.data.frame(wave, row.names = NULL, optional = NULL, xy = TRUE, cells=FALSE, time=FALSE, na.rm=TRUE, wide=TRUE)

head(wave_df)

tail(wave_df)

ggplot(data = wave_df, aes(x = Band_1)) +
  geom_histogram() +
  theme_minimal()

###################################################

wave_raw_df <- terra::as.data.frame(wave_raw, row.names = NULL, optional = NULL, xy = TRUE, cells=FALSE, time=FALSE, na.rm=TRUE, wide=TRUE)

head(wave_raw_df)

tail(wave_raw_df)

ggplot(data = wave_raw_df, aes(x = wave_notransform)) +
  geom_histogram() +
  theme_minimal()
```

```{r}
# Creating a scatterplot of data with the transformation line on it

graph_wa <- ggplot(data = wave_df, aes(x = , y =)) +
  geom_point() +
  theme_minimal()
```

### Wind energy
```{r}

wind <- terra::rast(here("data", "tiff", "wind_linfunc_v_ProjectRas.tif"))
wind_raw <- terra::rast(here("data", "tiff", "wind_notransform.tif"))

terra::plot(wind, main = "Wind Energy (transformed linearly)")
terra::plot(wind_raw, main = "Wind Energy (no transformation)")
```

```{r}
wind_df <- terra::as.data.frame(wind, row.names = NULL, optional = NULL, xy = TRUE, cells=FALSE, time=FALSE, na.rm=TRUE, wide=TRUE)

head(wind_df)

tail(wind_df)

ggplot(data = wind_df, aes(x = Band_1)) +
  geom_histogram() +
  theme_minimal()

###################################################

wind_raw_df <- terra::as.data.frame(wind_raw, row.names = NULL, optional = NULL, xy = TRUE, cells=FALSE, time=FALSE, na.rm=TRUE, wide=TRUE)

head(wind_raw_df)

tail(wind_raw_df)

ggplot(data = wind_raw_df, aes(x = Band_1)) +
  geom_histogram() +
  theme_minimal()

```

### Aquaculture 

```{r}
aqua <- terra::rast(here("data", "tiff", "aqua_sfunc_v2.tif")) #???????
aqua_raw <- terra::rast(here("data", "tiff", "aqua_notransform.tif"))

terra::plot(aqua, main = "Aquaculture Production (S-transformation)")
terra::plot(aqua_raw, main = "Aquaculture Production (no transformation)")
```

```{r}
aqua_df <- terra::as.data.frame(aqua, row.names = NULL, optional = NULL, xy = TRUE, cells=FALSE, time=FALSE, na.rm=TRUE, wide=TRUE)

head(aqua_df)

tail(aqua_df)

ggplot(data = aqua_df, aes(x = Band_1)) +
  geom_histogram() +
  theme_minimal()

###################################################
aqua_raw_df <- terra::as.data.frame(aqua_raw, row.names = NULL, optional = NULL, xy = TRUE, cells=FALSE, time=FALSE, na.rm=TRUE, wide=TRUE)

head(aqua_raw_df)

tail(aqua_raw_df)

ggplot(data = aqua_raw_df, aes(x = aqua_notransform)) +
  geom_histogram() +
  theme_minimal()
```

### Fisheries
SOMETHNG IS STILL WRONG HERE.
I think maybe there might be an issue with the pre-transformation raster still. Transformed data has 1,640,319 observations and pre-transformation only has 15,541, which is weird.
```{r}

fishy <- terra::rast(here("data", "tiff", "catchdata_outp_ProjectRas.tif"))
fishy_raw <- terra::rast(here("data", "tiff", "catchdata_notransform.tif"))

terra::plot(fishy, main = "Fisheries Production (Z-transformation)")
terra::plot(fishy_raw, main = "Fisheries Production (no transformation)")
```

```{r}
fishy_df <- terra::as.data.frame(fishy, row.names = NULL, optional = NULL, xy = TRUE, cells=FALSE, time=FALSE, na.rm=TRUE, wide=TRUE)

head(fishy_df)

tail(fishy_df)

ggplot(data = fishy_df, aes(x = catchdata_outp_ProjectRas)) +
  geom_histogram() +
  theme_minimal()

###################################################
fishy_raw_df <- terra::as.data.frame(fishy_raw, row.names = NULL, optional = NULL, xy = TRUE, cells=FALSE, time=FALSE, na.rm=TRUE, wide=TRUE)

head(fishy_raw_df)

tail(fishy_raw_df)

ggplot(data = fishy_raw_df, aes(x = catchdata_notransform)) +
  geom_histogram() +
  theme_minimal()
 # xlim(c(-1, 500000))
```
