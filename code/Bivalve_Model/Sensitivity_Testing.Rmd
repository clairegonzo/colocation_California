---
title: "Sensitivity Testing"
author: 'By: Claire Gonzales'
date: "2024-08-10"
output: 
  html_document: 
    theme: lumen
    toc: yes
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)

library(tidyverse)
library(here)
library(stats)
library(ggplot2)
library(stats)
```


## Read and wrangle in data
```{r}

output_main <- read.csv(here("data","bivalve_model","LookUpTable_201416.csv")) %>% 
  dplyr::select("site", "long", "lat", "yield")
output_s1 <- read.csv(here("data","bivalve_model","LookUpTable_s1.csv"))
output_s2 <- read.csv(here("data","bivalve_model","LookUpTable_s2.csv"))
output_s3 <- read.csv(here("data","bivalve_model","LookUpTable_s3.csv"))

```

```{r}
s1 <- output_s1 %>% 
  mutate(s1_yield = yield) %>% 
  dplyr::select("site", "long", "lat", "s1_yield")

s2 <- output_s2 %>% 
  mutate(s2_yield = yield) %>% 
  dplyr::select("site", "long", "lat", "s2_yield")

s3 <- output_s3 %>% 
  mutate(s3_yield = yield) %>% 
  dplyr::select("site", "long", "lat", "s3_yield")
```

Merging the 3 frames. Format will be wide so then we will make it longer.
```{r}
wide1 <- merge(output_main, s1, by = c("site", "long", "lat"), all = TRUE)

wide2 <- merge(s2, s3, by = c("site", "long", "lat"), all = TRUE)

wide <- merge(wide1, wide2, by = c("site", "long", "lat"), all = TRUE)
```

```{r}
alldata <- wide %>% 
  pivot_longer(yield:s3_yield,
               names_to = "test",
               values_to = "yield")
```

## Visualizations

```{r}
##boxplot and violin plot
ggplot(data = alldata, aes(x = test, y = yield, fill = test)) +
  geom_boxplot() +
  #geom_jitter(color="black", size=0.4, alpha=0.9) +
  theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
  theme_minimal()

ggplot(data = alldata, aes(x = test, y = yield, fill = test)) +
  geom_violin() +
  #geom_jitter(color="black", size=0.4, alpha=0.9) +
  theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
  theme_minimal()
```

## Percent change
```{r}
wide_percents <- wide %>% 
  mutate(s1_percchange = (((s1_yield-yield)/yield)*100),
         s2_percchange = (((s2_yield-yield)/yield)*100),
         s3_percchange = (((s3_yield-yield)/yield)*100),
         )

summary_percents <- wide_percents %>% 
  #group_by(site) %>% 
  summarize(mean_s1percchhange = mean(s1_percchange),
            mean_s2percchhange = mean(s2_percchange),
            mean_s3percchhange = mean(s3_percchange)
            )
```


## ANOVA
```{r}
summary(alldata)

```

```{r}
aov <- aov(yield ~ test, 
           data = alldata)

summary(aov)
```

```{r}
hist(aov$residuals)

ggplot(data = alldata, aes(sample = yield)) +
  geom_qq() +
  facet_wrap( ~ test) +
  theme_minimal()
```

## Visualization data transformations
This section deals with the production data and transformed production data from each of the 4 sub-models. We want to compare the transformed data to the theoretical transformation (line resulting from the equation we used to transform the data - how well do the data points sit on this line?).

I also want to use this opportunity to look at the production data (pre-transformation) in some non-spatial ways.

I will read in the rasters and then extract the value in each cell. 

Read in data using `terra`
```{r}
library(terra)
library(sf)
```

```{r}
wind <- terra::rast(here("data", "tiff", "wind_sfunc_v3.tif"))
```

```{r}
terra::plot(wind, main = "wave energy (transformed)", )
```

I will need to extract the location of each cell first and create a list of those points. Then as R to pull the value at each of those spatial points.
```{r}
wind_df <- terra::as.data.frame(wave, row.names = NULL, optional = NULL, xy = TRUE, cells=FALSE, time=FALSE, na.rm=TRUE, wide=TRUE) 

head(wind_df)

tail(wind_df)


## idk if this is working ##
# summ <- wind_df %>% 
#   group_by(Band_1) %>% 
#   summarize(n = n())
# 
# ggplot(data = wind_df, aes(x = Band_1)) +
#   geom_histogram() +
#   theme_minimal() +
#   xlim(c(0.01,1.00))
```

