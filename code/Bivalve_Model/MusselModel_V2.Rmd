---
title: "MusselModel_V2"
author: 'By: Claire Gonzales'
date: "2023-06-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)

library(tidyverse)
library(here)
#library(paletteer)
library(ggplot2)
library(pracma)
library(assertthat)

```

# Model Description
This is my second attempt to convert the bivalve mussel model into R code. This code is in 4 parts:
- Mussel Model Execute pt. 1
- Mussel ODE Solve function (a function that we write)
- Mussel Derivative function (a function that we write)
- Mussel Model Execute pt. 2

The Mussel Model Execute sections are what needs to be ran to actually create the results. The ODE solve function is used in the Mussel Model Execute code to calculate the results. The Mussel Derivative (nested in the ODE solve function) is a function that we create and plug in the the ODE solve function. Mussel Derivative is the function. ODE is a way for R to solve that equation for us.

Mussel Model Execute pt. 1 sets up everything that we need for the model (calls in data, etc), then I added in the functions, then Mussel Model Execute pt. 2 will actually create the table of results given those equations. There is an option to also get information about a single cell (submit a location query), but I am ignoring that for now and you'll notice that code chunk is given `eval = FALSE` because it was throwing some aesthetic errors that I just don't think we need to worry about right now.

# The Problem
I believe that my problem here lies in the use of the functions. Maybe I don't need to have them physically nested in one another for R to be able to work with them? But my current error and the crux of my question is in lines 184-191. This is in the Mussel Derivative function, which is in the Mussel ODE solve function. These lines of code are interpolating our physical data so that is can be used in the mussel derivative. Previously, we have interpolated the physical data from monthly values to get daily values for the study period (so, taking 18 values and expanding it to 547 values). I ~believe~ we are now taking those 547 values and interpolating to get the physical data that would be needed for a harvest cycle (367 days). But in doing so, it calls for a variable `T` to act as "xi = Numeric vector; points at which to compute the interpolation; all points must lie between min(x) and max(x)" [documentation on this function from: https://www.rdocumentation.org/packages/pracma/versions/1.9.9/topics/interp1]. But, as far as I can tell we do not know what T is yet. It seems like it is solved for in the outer loop of the ODE solve function (line 350).

Maybe I am wrong in that assumption? But, it seems to me that `mussel_derivative` is needed to solved for `mussel_odeSolve`, but `mussel_odeSolve` requires an output from `mussel_derivative` to be solved. How could this be?

Ultimately, I also think we could change the `pracma::interp1()` to `pracma::pchip()` to interpolate these values in a different way. But, I am unclear on what to put in the place of `T`. What am I missing here?



```{r}
# Mussel Model Execute

# Import data
celldata <- read.csv(here("data", "bivalve_model", "celldata4.csv"), header = FALSE)
# Look at data to make sure that there are no headers being used here.
## Dimensions should be 3442 rows & 75 columns (sites numbers in column 1)

# Create Time variable
year_Oct2Mar <- seq(as.Date("2014-10-01"), as.Date("2016-03-31"), by = "day")  # Harvest period range: 10/14 - 03/2016
startdate <- as.Date("2014-10-01")  # Set start date here
harvestcycle <- 365
days <- seq(startdate, by = "day", length.out = (harvestcycle + 2))
resetdate <- as.Date("2016-04-01")  # if harvest cycle extends beyond Mar 2016, then model will loop back to resetdate
row <- match(resetdate, year_Oct2Mar)

for (i in 1:length(days)) {
  while (days[i] > tail(year_Oct2Mar, 1)) {
    days[i] <- year_Oct2Mar[row]
    row <- row + 1
  }
}

```

```{r}
### STATIC PARAMETERS ###

## for mussel derivatives
# Rate parameter values given at reference temperature of 283K
v_ref <- 0.01359 # energy conductance rate cm/d
kM_ref <- 0.00447539 # maintenance rate coeff 1/d
maint_ratio <- 0.446888
yEX <- 0.696818 # yield of reserves from food (Cmole/Cmole; depends on food quality)
yVE <- 0.878007 # yield of structure from reserves
deltam <- 0.1989 # aspect ratio; see notes on size measures
kappa <- 0.9283 # fraction of reserves committed to growth + somatic maintenance
kappar <- 0.95 # conversion efficiency of reserves to gonad biomass
Mvdensity <- 0.0041841 # density of structure molC/cm3
Ehp <- 97.41 # maturity at puberty, J
mu_E <- 550000 # chemical potential of reserves, J/mol
Lp <- 0.753047 # structural length at puberty, cm
Jxmax <- 0.0000783383 # max surface specific feeding rate Cmoles/d cm2 for detrital C (addmypet)
# For T conversion
Ta <- 3243
Tref <- 293
```



```{r}
# Lookup Table ONLY

yield <- rep(0, nrow(celldata))
Wets <- matrix(NA, nrow = nrow(celldata), ncol = harvestcycle + 2)
ProblemCells <- matrix(0, nrow = nrow(celldata), ncol = 2)
  
for (i in 1:length(yield)) {
  tic()
  out <- mussel_odeSolve(i, celldata, days)
  TM <- out[[2]]
  Mwet <- out[[8]]
    
  yield[i] <- TM[length(TM)]
  Wets[i, 1:length(Mwet)] <- Mwet
    
  ProblemCells[i, 1] <- i
  if (length(TM) < harvestcycle + 2) {
    ProblemCells[i, 2] <- 1
  }
    
  toc()
}
  
# save(ProblemCells, file = "ProblemCells.RData")
  lookuptable <- cbind(celldata[, 1:4], yield, yield / 1000)
  # save(lookuptable, file = "Yield.RData")

```


```{r, eval=FALSE, include=FALSE}
# Lookup Table or Single Cell
### THIS CODE IS BUGGY ###
Ans0 <- readline("Create look-up table (T) or evaluate single cell (S)? (T/S)\n")
assertthat::assert_that(Ans0 %in% c("T", "S", na.rm = TRUE), "Please enter 'T' or 'S'")

tic()

# Lookup Table
if (Ans0 == "T") {
  yield <- rep(0, length(celldata))
  Wets <- matrix(NA, nrow = length(celldata), ncol = harvestcycle + 2)
  ProblemCells <- matrix(0, nrow = nrow(celldata), ncol = 2)
  
  for (i in 1:length(yield)) {
    tic()
    out <- mussel_odeSolve(i, celldata, days)
    TM <- out[[2]]
    Mwet <- out[[8]]
    
    yield[i] <- TM[length(TM)]
    Wets[i, 1:length(Mwet)] <- Mwet
    
    ProblemCells[i, 1] <- i
    if (length(TM) < harvestcycle + 2) {
      ProblemCells[i, 2] <- 1
    }
    
    toc()
  }
  
  #save(ProblemCells, file = "ProblemCells.RData")
  lookuptable <- cbind(celldata[1:4], yield, yield / 1000)
  #save(lookuptable, file = "Yield.RData")
  
} else {
  toc()
  # Single Cell
  cellno <- as.integer(readline("Choose a cell (1-1134)\n"))
  assertthat::assert_that(cellno >= 1 && cellno <= nrow(celldata), na.rm = TRUE, "Please enter a number between 1 and 1134")
  tic()
  
  out <- mussel_odeSolve(cellno, celldata, days)
  T <- out[[1]]
  TM <- out[[2]]
  Mwet <- out[[8]]
  
  outputs <- cbind(T, Mwet, out[[6]], out[[12]], out[[13]], out[[7]], TM)
  toc()
  
  # Plots
  # Ans2 <- readline("Plot results? (Y/N)\n")
  # assertthat::assert_that(Ans2 %in% c("Y", "N"), "Please enter 'Y' or 'N'")
  # if (Ans2 == "Y") {
  #   musselplot(T, TM, out[[13]], Mwet, out[[6]], out[[7]], out[[12]], out[[11]], out[[14]])
  # }
}

```


