---
title: "MusselModel_Execute"
author: 'By: Claire Gonzales'
date: "2023-06-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)

library(tidyverse)
library(here)
library(paletteer)
library(ggplot2)
library(pracma)
```

# Mussel model

## Import Data
```{r}
#loading data
celldata <- read.csv(here("data", "bivalve_model", "celldata4.csv"), header = FALSE)

```

```{r}
# create time variables
year_Oct2Mar <- seq(as.Date("2014-10-01"), as.Date("2016-03-31"), by = "day")
startdate <- as.Date("2014-10-01")
harvestcycle <- 365
days <- seq(startdate, by = "day", length.out = harvestcycle + 2)
resetdate <- as.Date("2015-04-01")
row <- which(year_Oct2Mar == resetdate)[1]

for (i in seq_along(days)) {
  while (days[i] > year_Oct2Mar[length(year_Oct2Mar)]) {
    days[i] <- year_Oct2Mar[row]
    row <- row + 1
  }
}
```


## Mussel Derivative function
```{r}
mussel_derivative <- function(N, t, mlds, Temps, Fs, Vs) {
  mE <- N[1]
  L_w <- N[2]
  MR <- N[3]
  F <- N[4]
  n <- N[5]
  
  # Environmental variables
  Temp <- pchip(Time, Temps, T)
  V <- pchip(Time, Vs, T)
  mld <- pchip(Time, mlds, T)
  F_in <- pchip(Time, Fs, T)
  
  ## Static parameters
  # rate parameter values given at reference temperature of 283K
  v_ref <- 0.01359 #energy conductance rate cm/d 
  kM_ref <- 0.00447539 # maintetance rate coeff 1/d
  maint_ratio <- 0.446888
  yEX <- 0.696818 # yield of reserves from food(Cmole/Cmole; depends on food quality)
  yVE <- 0.878007 # yield of structure from reserves
  deltam <- 0.1989 # aspect ratio; see notes on size measures
  kappa <- 0.9283 # fraction of reserves commited to growth + somatic maintenance
  kappar <- 0.95  # conversion efficiency of reserves to gonad biomass
  Mvdensity <- 0.0041841 # density of structure molC/cm3
  Ehp <- 97.41 # maturity at puberty, J
  mu_E <- 550000 # chemical potential of reserves, J/mol
  Lp <- 0.753047 # structural length at puberty, cm
  Jxmax  <- 0.0000783383 #max surface specific feeding rate Cmoles/d cm2 for detrital C (addmypet)
  
  # For T conversion
  Ta <- 3243
  Tref <- 293
  
  ## Temperature dependant parameters
  # conversion function to calculate rate parameters for actual temperature
  Arrh <- exp((Ta/Tref) - (Ta/Temp))
  
  v <- Arrh*v_ref # temperature adjusted energy conductance rate (cm/d)
  v_w <- v/deltam # temperature adjusted physical length conversion rate (cm/d)
  Mvdensity_w <- Mvdensity*deltam^3 
  Lp_w <- Lp/deltam # shell length at puberty (approx 1.2 cm)
  kM <- kM_ref*Arrh # temperature adjusted maintenance rate coeff (1/d)
  jEM <- 1*kM/yVE #1.4672 #kM/yVE [maintenance rate coeff/yield of structure from reserves]- (1/d)
  kJ <- maint_ratio*jEM*yVE # = maint_ratio*kM [maintenance ratio * maintenance coefficient]
  
  # Constants and parameters
  # yEX <- 1  # reserve flux efficiency (J_X / J_E) (-)
  # Jx <- 0  # food intake (J/d)
  # jEM <- 0.002  # somatic maintenance rate (J/d)
  # Ehp <- 3.75e5  # maturity threshold (J)
  # kJ <- 1e8  # maturation rate (1/d)
  # v_w <- 0.05  # energy conductance (cm/d)
  # Lp_w <- 15  # maximum length (cm)
  
  ## Functional Response
  # Farm dimensions
  farm_area <- 1000*mld #Cross-sectional area of farm in m2
  
  #Food competition
  r <- V*farm_area*10000 # V(cm/d)*farm_area(m2)*10000(cm2/m2) = (cm3/d)
  supply <- (F_in*r) # F_in(molC/cm3)*r(cm3/d) = (molC/d)
  #Fh <- 2.9836e-8 # half saturation constant (molC/cm3)
  Fh <- 1.21e-8 #half saturation constant (molC/cm3)
  #Calculation: 2.98363e-6 molC/L - from addmypet -- *(1L/1000cm3) = 2.9836e-9 molC/cm3
  f <- F/(Fh+F) # scaled functional response
  Jx <- Jxmax*L_w^2*f #scaled individual rate of food consumption (molC/d);
  consumption <- n*Jx # total food consumption by whole mussel population (molC/d)
  dF <- supply - consumption - r*F
  
  # Derivatives
  dF <- 0
  if (L_w >= Lp_w) {
    if (MR > 0) {
      dmE <- yEX * Jx / (mlds[t] * L_w^3) - v_w * mE / L_w
      Jcr <- mlds[t] * L_w^3 * (v_w * mE / L_w - jEM) - kJ * Ehp / mu_E
      # assuming resorption conversion efficiency of 1
      print("Animal is starving; gonad resorption for maintenance")
      print("See Roger or Erik")
    } else {
      dmE <- yEX * Jx / (mlds[t] * L_w^3) - jEM
      print("Animal is starving; extra reserve mobilization to pay somatic maintenance")
      print("This is a debatable choice; Standard DEB prescribes death")
      print("See Erik or Roger")
      if (mE < 0) {
        dmE <- 0
        print("Animal starved to death")
      }
    }
  } else {
    dmE <- yEX * Jx / (mlds[t] * L_w^3) - jEM
    print("Animal is starving; extra reserve mobilization to pay somatic maintenance")
    print("This is a debatable choice; Standard DEB prescribes death")
    print("See Erik or Roger")
    if (mE < 0) {
      dmE <- 0
      print("Animal starved to death")
    }
  }
  
  dn <- 0
  
  output <- c(dmE, dL_w, Jcr, dF, dn)
  return(output)
}

```


## Mussel ODE Solve
```{r}

mussel_odeSolve <- function(cellno, celldata, days) {
  # Interpolate to get daily values for Temp, Vs, F, mld (so datasets match 'Time')
  year_Oct2Mar <- seq(as.Date("2014-10-01"), as.Date("2016-03-31"), by = "day")
  growPeriod <- length(days) - 1
  dayno <- which(days[1] == year_Oct2Mar)[1]
  
  ## Mixed layer depth in meters(m)
  mld_monthly <- celldata[4:21]
  
  # Create an empty matrix to store the interpolated values
  mld_daily <- matrix(nrow = length(mld_monthly[[1]]), ncol = 547)
  # Convert each column to a numeric vector and apply pchip(), and fill the matrix with the interpolated values
  for (i in 1:nrow(mld_monthly)) {
    row_vector <- as.numeric(mld_monthly[i,])
    interp_vector <- pchip(1:18, row_vector, seq(1,18, by = 0.0311))
    mld_daily[i ,] <- interp_vector
    }
  mlds <- mld_daily[dayno:dayno + growPeriod]
  
  ## Temperature in Kelvin
  Temp_monthly <- celldata[22:39] + 273
  #holding matrix
  Temp_daily <- matrix(nrow = length(Temp_monthly[[1]]), ncol = 547)
  # Convert each column to a numeric vector and apply pchip(), and fill the matrix with the interpolated values
  for (i in 1:nrow(Temp_monthly)) {
    row_vector <- as.numeric(Temp_monthly[i,])
    interp_vector <- pchip(1:18, row_vector, seq(1,18, by = 0.0311))
    Temp_daily[i ,] <- interp_vector
    }
  Temps <- Temp_daily[dayno:dayno + growPeriod]
  
  ## POC in molC/cm3
  # Calculation: X (mgC/m3) * (1molC/12000mgC) * (1m3/1000000cm3)
  F_monthly <- celldata[58:75] / 12e9
  # holding matrix
  F_daily <- matrix(nrow = length(F_monthly[[1]]), ncol = 547)
  # Convert each column to a numeric vector and apply pchip(), and fill the matrix with the interpolated values
  for (i in 1:nrow(F_monthly)) {
    row_vector <- as.numeric(F_monthly[i,])
    interp_vector <- pchip(1:18, row_vector, seq(1,18, by = 0.0311))
    F_daily[i ,] <- interp_vector
    }
  Fs <- F_daily[dayno:dayno + growPeriod]
  
  ## Current speed in cm/d
  # Calculation: Input data = m/s; X (100cm/m) * (86400s/d)
  V_monthly <- celldata[40:57] * 8640000
  # holding matrix
  V_daily <- matrix(nrow = length(V_monthly[[1]]), ncol = 547)
  # Convert each column to a numeric vector and apply pchip(), and fill the matrix with the interpolated values  
  for (i in 1:nrow(V_monthly)) {
    row_vector <- as.numeric(V_monthly[i,])
    interp_vector <- pchip(1:18, row_vector, seq(1,18, by = 0.0311))
    V_daily[i ,] <- interp_vector
    }
  Vs <- V_daily[dayno:dayno + growPeriod]
  
  # Set time range/length of harvest cycle
  Time <- days
  
  # Set initial conditions
  L_w_init <- 0.03
  mE_init <- (4.24e-10 / 3.22e-10)
  MR_init <- 0
  F_init <- Fs[1]
  n_init <- 100 * 13000 * 100
  
  Init <- c(mE_init, L_w_init, MR_init, F_init, n_init)
  
  # ODE Solver
  ode_derivative <- function(t, N) {
    mussel_derivative(N, t, mlds, Temps, Fs, Vs)
  }
  
  T <- ode23(ode_derivative, 0, 367, Init, atol = 1e-7, rtol = 1e-7)$xout
  
  # Derived Values (weights of product)
  deltam <- 0.1989 # aspect ratio; see notes on size measures
  Mvdensity <- 0.0041841 # density of structure molC/cm3
  Mvdensity_w <- Mvdensity * deltam^3
  LW <- T[, 2] # apical length of an individual mussel (cm)
  MV <- 12 * Mvdensity_w * LW^3 # structural biomass of an individual mussel (gC)
  ME <- 12 * Mvdensity_w * T[, 1] * LW^3 # reserve biomass of an individual mussel (gC)
  MR <- 12 * T[, 3] # reproductive biomass of an individual mussel (gC)
  M <- MV + ME + MR # total biomass of an individual mussel (gC)
  Indiv <- T[, 5]
  C_content <- 0.034 #  Carbon weight/wet weight; Haamer, J. 1996.
                # Improving water quality in a eutrophied fjord system with mussel
                # farming. Ambio. Vol. 25. pp. 356-362.
  TM <- Indiv * M / (1000 * C_content) # total biomass of all mussels on the farm (kg)
  Mwet <- M / C_content # wet weight of individual mussel (g)
  
  # Available Food
  Fdens <- T[, 4] * 12e9 # in mgC/m3
  # Calculation: X (molC/cm3) / [(1molC/12000mgC) * (1m3/1000000cm3)]
  
  # Functional Response
  Fh <- 1.21e-8
  f <- T[, 4] / (Fh + T[, 4]) # scaled functional response
  
  # Physical Conditions
  Temperature <- pchip(Time, Temps, T[, 1]) - 273
  MixedLayerDepth <- pchip(Time, mlds, T[, 1])
  F_Ambient <- pchip(Time, Fs, T[, 1]) * 12e9
  CurrentSpeed <- pchip(Time, Vs / 8640000 , T[, 1])
  
  return(list(T, TM, Indiv, MV, ME, MR, M, Mwet, LW, Fdens, F_Ambient, f, Temperature, MixedLayerDepth, CurrentSpeed))
}

```



## Execute Lookup Table or Single Cell
```{r}
# prompt
Ans0 <- readline(prompt = 'Create look-up table (T) or evaluate single cell (S)? (T/S)\n')
T
assert <- function(test, message) {
  if (!test) {
    stop(message)
  }
}

assert(Ans0 == 'T' || Ans0 == 'S', 'Please enter "T" or "S"')
tic()
```

Lookup Table/Single Cell
```{r}
# Lookup Table

if (Ans0 == 'T') {
  yield <- rep(0, length(celldata))
  Wets <- matrix(NA, nrow = length(celldata), ncol = harvestcycle + 2)
  ProblemCells <- matrix(0, nrow = length(celldata[, 1]), ncol = 2)
  
  for (i in seq_along(yield)) {
    
    tic()
    
    output <- mussel_odeSolve(i, celldata, days)
    TM <- output$TM
    Mwet <- output$Mwet
    yield[i] <- TM[length(TM)]
    Wets[i, 1:length(Mwet)] <- Mwet
    ProblemCells[i, 1] <- i
    if (length(TM) < harvestcycle + 2) {
      ProblemCells[i, 2] <- 1
    }
    
    toc()
    
  }
  # save('ProblemCells.csv', ProblemCells) #commenting out unless we decide we need to write a csv
  lookuptable <- cbind(celldata[, 1:4], yield, yield/1000)
  # save('Yield.csv', lookuptable) #commenting out unless we decide we need to write a csv
} else{
  
  toc()
  
  # Single Cell
  cellno <- as.integer(readline(prompt = 'Choose a cell (1-1134)\n'))
  assert(cellno <= length(celldata[, 1]) && cellno >= 1, 'Please enter a number between 1 and 1134')
  tic()
  output <- mussel_odeSolve(cellno, celldata, days)
  T <- output$T
  TM <- output$TM
  Indiv <- output$Indiv
  MV <- output$MV
  ME <- output$ME
  MR <- output$MR
  M <- output$M
  Mwet <- output$Mwet
  LW <- output$LW
  Fdens <- output$Fdens
  F_Ambient <- output$F_Ambient
  f <- output$f
  Temperature <- output$Temperature
  MixedLayerDepth <- output$MixedLayerDepth
  CurrentSpeed <- output$CurrentSpeed
  outputs <- cbind(T, Mwet, LW, f, Fdens, F_Ambient, TM)
  
  toc()
  
  # Plots
  # Ans2 <- readline(prompt = 'Plot results? (Y/N)\n')
  # assert(Ans2 == 'Y' || Ans2 == 'N', 'Please enter "Y" or "N"')
  # if (Ans2 == 'Y') {
  #   musselplot(T, TM, f, Mwet, LW, Fdens, F_Ambient, Temperature, MixedLayerDepth, CurrentSpeed)
  # }
}
```

